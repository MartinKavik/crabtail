image: ubuntu/focal

sources:
  - https://git.sr.ht/~azzamsa/crabtail

packages:
  - nodejs
  - yarn
  # cargo-make needs these
  - pkg-config
  - libssl-dev

environment:
  project: crabtail

secrets:
  - 1cf349b2-4fe8-4fbe-9640-a9c79b447ee1 # Netlify auth token
  - 9db67c26-4aa9-454f-a2fd-3b126c262096 # Netlify site id

tasks:
  - deploy: |
      cd ${project}

      # install rustup
      curl https://sh.rustup.rs -sSf | sh -s -- -y
      export PATH="$HOME/.cargo/bin:$PATH"

      # install Rust stable
      rustup install stable --profile minimal
      cargo install --force cargo-make --version 0.32.14

      # install JS depedencies
      # locally isnstalled yarn is too old
      cargo install fnm
      eval "$(fnm env)"
      fnm install v14.15.4
      fnm use v14.15.4
      fnm default v14.15

      npm install -g yarn
      yarn global add npx prettier
      export PATH="$HOME/.yarn/bin:$PATH"
      yarn install

      # build
      cargo install wasm-bindgen-cli --version 0.2.72
      cargo make build_release

      # deploy
      set +x
      NETLIFY_AUTH_TOKEN=$(cat ~/.NETLIFY_AUTH_TOKEN)
      NETLIFY_SITE_ID=$(cat ~/.NETLIFY_CRABTAIL_ID)

      yarn global add --unsafe-perm=true netlify-cli@3.11.0
      netlify deploy --site $NETLIFY_SITE_ID --auth $NETLIFY_AUTH_TOKEN --prod --dir ./dist
