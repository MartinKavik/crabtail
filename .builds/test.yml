image: ubuntu/focal

sources:
  - https://git.sr.ht/~azzamsa/crabtail

packages:
  - nodejs
  - yarn
  # cargo-make needs these
  - pkg-config
  - libssl-dev

environment:
  project: crabtail

tasks:
  - test: |
      cd ${project}

      # install rustup
      curl https://sh.rustup.rs -sSf | sh -s -- -y
      export PATH="$HOME/.cargo/bin:$PATH"

      # install Rust stable
      rustup install stable --profile minimal
      cargo install --force cargo-make --version 0.32.14

      # install Rust nightly
      rustup toolchain install nightly
      rustup component add rustfmt --toolchain nightly

      # install JS depedencies
      # locally isnstalled yarn is too old
      cargo install fnm
      eval "$(fnm env)"
      fnm install v14.15.4
      fnm use v14.15.4
      fnm default v14.15

      npm install -g yarn
      yarn global add npx prettier
      export PATH="$HOME/.yarn/bin:$PATH"
      yarn install

      # test
      cargo make verify_only
