image: alpine/3.13

sources:
  - https://git.sr.ht/~azzamsa/crabtail

packages:
  - nodejs
  - yarn
  - rustup
  - openssl-dev # cargo-make needs
  - wget

environment:
  project: crabtail

secrets:
  - 1cf349b2-4fe8-4fbe-9640-a9c79b447ee1 # Netlify auth token
  - 20ebe8c5-7bbd-406e-8027-320d12e841ac # Netlify site id

tasks:
  - test: |
      cd ${project}

      # install rustup
      rustup-init -y --profile minimal
      export PATH="$HOME/.cargo/bin:$PATH"

      # install Rust stable
      rustup install stable --profile minimal
      cargo install --force cargo-make --version 0.32.14

      # install Rust nightly
      rustup toolchain install nightly
      rustup component add rustfmt --toolchain nightly

      # install JS depedencies
      yarn global add npx
      export PATH="$HOME/.yarn/bin:$PATH"
      yarn install

      # test
      cargo make verify_only

